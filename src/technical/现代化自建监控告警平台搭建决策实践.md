> 本文为 2022 GNSEC 在线大会的分享内容整理。

## 现代化监控告警平台需求场景
首先我们可以来思考一下监控与告警的本质。所谓监控，从字面意思来说，就是监看并进行控制。“监”是对数据的洞察，通过观察数据发现是否有异常；“控”也就是操作响应，表示一种行为，当发现异常之后，需要通过一定的手段来处理问题，从而让系统恢复到正常状态。告警在这个过程中扮演的是一种媒介信号，也就是说，在观察到异常状况之后，通过告警将该消息通知给用户或自动化系统，然后完成操作响应的过程。
广义上的监控其实在日常生活中非常常见，例如交通抓拍，摄像头会拍摄违章的车辆（“监”），然后会生成一条违章记录（类似于“告警”），然后交管部门会有一定的处罚措施（“控”）。在计算机系统中的话，通常我们是对硬件、操作系统、以及各种服务的监控。
![image.png](/img/src/technical/现代化自建监控告警平台搭建决策实践/9c76f1a95fe2497906d9a1e00297769b0bb21c2f67e19a729de749a9666e5fe8.png)
通过上面的流程分析，我们可以梳理出一些典型的需求场景，例如：

- 数据洞察阶段
   - 需要能够高效、快速地从大量数据中发现问题，尽可能保证时效性。
   - 由于所观察的数据来自于不同的设备或服务，因此数据有着各种各样的差异，所以需要能够支持异构数据的系统与统一监控。
- 告警管理阶段
   - 在同时产生大量告警的情况下，需要有一定的降噪机制，避免海量通知。
   - 需要能够根据告警信息灵活地决定如何发送通知。例如不同服务的告警发送给不同的人，或者不同严重度的告警使用不同的方式来通知。
- 操作响应阶段
   - 需要能够支持丰富的通知渠道和通知内容，从而便于快速触达，并且能够提供充足的上下文信息，方便快速查看和发现问题。
   - 需要具备一定的自动化响应能力，对于常见问题可以实现自动化响应与故障自愈，提高故障解决效率。
## 典型平台的架构与模块
一个典型的监控告警平台，基本架构如下：
![image.png](/img/src/technical/现代化自建监控告警平台搭建决策实践/e69a1cd0d9f85d127163a78eb4d4fa30b0b74d7e1ee87aa1fc84a9a8ed65333b.png)
其中橙色部分可以认为是一些外部依赖，主要是数据源以及数据存储；蓝色部分就是监控告警平台的一些必要模块。整体工作流程如下：

- 各种设备、系统、服务等产生了各种各样的数据（比如系统指标、服务访问日志等），通过Agent采集、SDK发送等方式采集到数据存储层。
- 基于这些数据，我们配置各种各样的监控任务，例如监控主机的 CPU 使用率、监控服务的 QPS 等。这些任务的监控对象以及监控周期都根据实际需要存在着一定的差异。
- 任务调度模块会按照每个任务的执行周期，去调度这些任务的执行。
- 监控任务如果发现有数据异常，就会触发告警，从而进入告警管理模块，执行告警降噪、路由分派等操作。
- 然后告警进入到行动管理模块进行通知，通过短信、邮件、钉钉等方式通知给接收人，或者通过服务调用通知给程序，从而介入到故障恢复的流程中，来保证所监控的对象恢复正常。
## 开原方案的选择与对比
为了构建一套生产可用的监控告警平台，常常会用到多个开源组件进行写作。例如下图就是一个可行的开源方案组合：
![image.png](/img/src/technical/现代化自建监控告警平台搭建决策实践/b79e4cde3764f3adbb6f725e7b8edba70da3e4267851a8038f9f849506989bbe.png)

- 使用 zabbix 进行一些系统层的监控
- 使用 ElasticSearch 进行日志的存储和分析，然后使用 Kibana 进行可视化和监控；或者使用 Loki 来管理日志，然后配置告警规则，并将告警发送给 AlertManager
- 对于指标数据，使用 Prometheus 来进行管理，然后配置告警并发送给 AlertManager
- 为了统一的通知管理，可以将这些系统产生的告警统一发送给 GoAlert（可选模块），然后对接 Webhook、短信、邮箱等多种通知渠道

这样的一套系统其实相对来说比较容易实现，并且在一定程度上是可以满足我们需求的，尤其是对于数据量不是特别大的场景。但是该方案同样不可避免地存在着如下几个痛点：

- 重复建设：一方面每个开源组件都有各自适用的场景，因此为了功能的完整性，往往需要多个组件配合使用，从而带来了较高的维护成本。另一方面部分开源组件在面临大量数据时，可靠性及稳定性也有一定潜在的风险。
- 数据孤岛：不同的开源组件各自为政，因此不同的数据协作就会比较困难。例如希望 ElasticSearch 中的日志数据与 Prometheus 中的指标数据结合起来做一些监控规则，就会比较麻烦。
- 海量告警：缺乏统一的降噪机制，有可能导致海量的告警无法收敛。
- 通知简单：通知渠道的支持相对会少一些，通知内容的定制相对简单。如果需要更丰富的通知，需要一些额外的开发工作。 
## 统一监控告警平台
基于上述的痛点考虑，我们自建了一套完整的监控告警平台。基于阿里云日志服务统一的可观测数据存储能力，以及统一的查询分析预发，可以相对比较高效地实现对各种异构可观测数据的分析与使用。
### 整体架构
日志服务提供了统一的可观测存储能力，对于日志、指标、Trace等数据，可以无差别地进行存储和使用。
 ![image.png](/img/src/technical/现代化自建监控告警平台搭建决策实践/fabb82e792ab819e7d176088b94bddfebaf50ebf375e11a8b73ccb37371462cb.png)
在此之上，日志服务还提供了统一的查询分析能力，基于标准SQL语法，集合了 PromQL 的能力，并且进行了大量的函数扩展，从而可以方便快捷地对可观测数据进行统一的分析。
![image.png](/img/src/technical/现代化自建监控告警平台搭建决策实践/60f113c122c47cff2c068cb890a63db5e12dc8ee8e109aa66e06c41ef996b1b3.png)
例如下面的例子，不仅可以使用SQL对日志字段进行过滤和分析，还可以使用PromQL语法对指标进行分析，此外，甚至还可以通过子查询的方式，实现进一步的聚合操作，或者结合机器学习函数，实现数据的预测能力。
![image.png](/img/src/technical/现代化自建监控告警平台搭建决策实践/913883949f60ade2d21c8efd5f8b3a2e30ef7acd080dd244f18126ccd5a8e67c.png)
最终整体的告警架构参考如下：
![image.png](/img/src/technical/现代化自建监控告警平台搭建决策实践/7b9f9829b39e7c8fc1a61d59dee03a153764d24cdcaaa99dfc164938596e9426.png)整体上分为如下几个部分：

- 告警监控：对数据进行检查评估，提供了包括对单一数据源的监控，多个异构数据源的协同监控，以及对多个监控对象的分组评估等能力，此外还提供了大量的内置监控规则，可以一键开启直接使用。
- 告警管理：监控产生的告警会发送到告警管理模块，在这里可以对告警进行统一的去重、合并、抑制、静默等降噪机制。
- 通知管理：降噪后的告警会进入到通知管理流程，在这里可以进行通知分派，配置通知渠道、通知内容、接收人等信息。
- 开放告警：如果原始的可观测数据尚未接入到统一存储，那么可以通过开放告警的方式，将自建系统的告警数据直接发送给告警管理系统，从而实现云上云下告警和通知的统一管理。
### 高可用与扩展
基于上面的架构，在技术层面上，我们不可避免地会面临着高可用与扩展性的问题。例如对于Prometheus，监控任务的状态等数据默认都是存在内存中，如果服务重启，那么这些信息就可能会丢失，另外它本身并不具备高可用的能力，需要借助于 Thanos 等组件来实现高可用。另外对于开源告警管理系统 AlertManager，很多状态也是存在于内存中，如果服务重启，也会带来一定的状态丢失。因此我们在实现的时候，将许多状态统一放在了外部缓存之中，包括监控规则的评估状态、告警的触发状态、告警的合并、抑制、通知等状态，这样就可以实现计算层和存储层的分离，监控服务和告警管理通知服务更多的是做计算，因此也就变成了一个无状态服务，可以非常轻松地做横向扩展。
![image.png](/img/src/technical/现代化自建监控告警平台搭建决策实践/d3cae11912e3e1c8f12ff568cacaf10819879810be675fd87d8e30c7ea97567e.png)
### 多租户与多策略
由于是云上的服务，因此需要考虑多租户与多策略的场景。首先是针对不同用户的数据隔离，然后同一个用户下，也要根据不同的策略做数据隔离，以便于适应多个团队、多个业务系统的场景。
![image.png](/img/src/technical/现代化自建监控告警平台搭建决策实践/9032a06ca33444b2a36cfa60b9513bd1f434f5c44e2e23b6ba4c61513b494ae7.png)
### 算法赋能：智能降噪
关于告警合并降噪，主要有两种方式：基于规则的合并，以及基于算法的合并。每种方式都有各自的一些有点和不足。

- 基于规则相对比较简单，可以明确地配置基于告警的哪些属性进行合并降噪，相对直观明了。但是它在一定程度上依赖于人的经验，无法做到数据自适应，例如有一个新的服务告警，那么就很可能不满足已有的合并规则，需要重新调整规则。
- 基于算法的降噪可以自动根据告警的相似度进行告警的合并，因此可以很好地对数据进行自适应。但是它的一个潜在的不足就是合并的结果可能无法明确预测。

![image.png](/img/src/technical/现代化自建监控告警平台搭建决策实践/2fcc64e6fb00a2ec0399e56cd9412fb51ebe39af58a6f278aed6f4b31f581ea8.png)
智能合并的一个整体流程参考如下：

- 首先是各个系统产生的告警数据进入到智能合并模块，这些不同来源的告警会汇集起来，统一进行处理。
- 基于告警专业特色词、停用词库、数据字典、人工标注信息等，对告警全文本进行预处理，剔除无用文本，提取关键词。
- 采用 MinJoin 聚类算法以及向量相似度聚类算法，分别对告警文本进行聚类。
- 最后将两种聚类技术各自聚类的结果进行合并，得到最终的聚类结果。

![image.png](/img/src/technical/现代化自建监控告警平台搭建决策实践/f5e4db395f54c2c3d5eed20c367bc9c7d029b3d597ab355595a20f4ef6952c70.png)
## 未来与展望
对于未来，我们相信会朝着以下三方面不断发展：

- 统一化：包括数据的存储、查询分析、可视化、监控告警等都会进行统一，从而弱化不同地域、不同类型、不同结构数据之间的边界。只有相对统一了，这些不同来源不同格式的数据才能够被更加高效地使用。
- 自动化：目前的自动化更多是根据一些预设的规则，当告警触发后，匹配这些预设的规则，然后触发自动化操作，实现故障自愈。随着系统的不断发展，会有越来越多的故障类型以及自动化工具的集成，从而实现对多数故障的自动处理，从而更大程度上提高故障处理效率，减少人力投入。
- 智能化：根据资源、服务等之间的拓扑结构，自动发现问题根因，并结合自动化能力快速修复问题。例如在错综复杂的微服务调用中，自动分析出可能得问题根源，从而实现快速的故障解决。
